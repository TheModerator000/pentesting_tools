#!/bin/bash

#Version 1.2
#Author: Cade Forbes

package="libjson-perl"
debInst() {
    dpkg-query -Wf'${db:Status-abbrev}' "$package" 2>/dev/null | grep -q '^i'
}
 
if debInst "$package"; then
    echo
else
    printf 'I regret to inform you that the package %s is not currently installed.\nPlease wait.\nScript will resume after package installation.\n' "$package"
    sleep 4
    sudo apt install ${package}&
    wait
    echo
    echo
    echo
    echo "Your script will now continue as normal..."
    sleep 4
    echo
    echo

fi

SCRIPT_HOME_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

varOutPath="SSLSnag"

mkdir ${varOutPath}


#Grabbing IPs and Ports of ssl services from summary.txt
varSSLList=$(cat summary.txt | grep 'ssl')

varSSLIPs=$(echo $varSSLList | grep -Eo '([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})')

varSSLPorts=$(echo $varSSLList | grep -Eo '([0-9]{1,5})\s/' | grep -Eo '([0-9]{1,5})')


#Setting array for IP and Port lists to iterate through
counter=-1
for ip in ${varSSLIPs[@]}
	do 
		IPs+=($ip)
	done

for p in ${varSSLPorts[@]}
        do 
                Ports+=($p)
        done


#Main FOR Loop to scan each applicable IP:PORT and save results to unique files
for ip in ${varSSLIPs[@]}
        do 
				counter=$((counter+1))
                (sslscan $ip:${Ports[counter]} | tee ./SSLSnag/sslscan_$ip:${Ports[counter]})&
        done
		wait

#Parsing through SSL Scan files and printing Vulnerabilities
cd ${varOutPath}/
perl "$SCRIPT_HOME_DIR"/sslparse.pl ./sslscan_*
echo
echo 
echo
echo ====================== Results ======================
cat *.spl
cd ..
