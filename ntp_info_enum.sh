#!/bin/bash

#take the host file
hosts=$1

#Read host file line by line
while IFS= read -r host || [[ -n "$host" ]]; do
	echo "Connecting to $host..."
	
	#Attempt to connect using ntpq
	(echo "host"; sleep 1; echo "ntpversion"; sleep 1; echo "associations"; sleep 1; echo "sysinfo"; sleep 10) | ntpq "$host" >> ntp_info.txt &
	
	#Wait for 5s so that the command can finish up
	sleep 5
	
	#Check to see if the process is still running
	if ps -p $! > /dev/null; then
		#log the ntpq data.
		if grep -q "version" ntp_info.txt; then
			echo "***Data for $host logged.***"
		else
			echo "***No Data logged for $host.***"
		fi
		
		#after the data is logged/not logged check to see if it is still running. If so, kill it.
		if ps -p $! > /dev/null; then
			echo "***Closing connection and moving to the next host. :^)"
			kill $!
		fi
	fi
	
	echo
done < "$1"
